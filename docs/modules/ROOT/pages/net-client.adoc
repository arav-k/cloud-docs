= .Net Client
:url-github-net: http://hazelcast.github.io/hazelcast-csharp-client/dev/doc/configuration.html

== Quick Setup

== Before you Begin

. link:https://cloud.hazelcast.com/sign-up[Sign up for a Hazelcast Cloud account].

. Create a free cluster on the Basic plan. For help creating a cluster, see xref:getting-started.adoc[].

== Download and Run the Sample Code

. Click *Configure Client*.

. Go to the *.Net* tab and download the ZIP file as instructed in Step 1 of the dialog box.

. Extract the ZIP file and run the command, in the extracted folder, shown in Step 2 of the above dialog box.

You should see log output similar to the following:

image:net-client-log.png[.Net client logs that it is connected]

`Connection Successful!` in your logs means that your client application has successfully connected to your cluster in Hazelcast Cloud. The sample code inserts random entries to your cluster as you can see in the logs. In your Hazelcast Cloud console (your cluster's page where you can reach from the "Clusters" top menu), you should see the charts are being populated with metrics of your map, as shown below:

image:map-metrics-client-connection.png[Map metrics that show entries are being added to the map]

== Client Code

Now, as we have successfully connected and put data into the cluster, let's review and explain the client code you downloaded.

Go to the directory (extracted from the ZIP you downloaded in the Step 3 above) and locate the client sample code. If you had enabled encryption in your cluster, open the `ClientWithSsl/Program.cs` file. We will explain the code line by line in the following section.

=== ClientWithSsl/Program.cs

This is the downloaded sample client code with encryption.

[source,cs]
----
using System;
using System.Security.Authentication;
using System.Threading.Tasks;
using Hazelcast;
using Hazelcast.Networking;
using Microsoft.Extensions.Logging;

namespace ClientWithSsl
{
    /*
     * A sample application that configures a client to connect to an Hazelcast Cloud cluster
     * with SSL, and to then put and get random values in/from a map, thus testing that the
     * connection to the Hazelcast Cloud cluster is successful.
     *
     * see: https://hazelcast.github.io/hazelcast-csharp-client/
     */
    internal static class Program
    {
        private const int IterationCount = 100;

        public static async Task Main(string[] args)
        {
            Console.WriteLine();
            Console.WriteLine("Hazelcast Cloud Client with SSL");

            Console.Write("Build options...");
            var options = new HazelcastOptionsBuilder()
                .With(args)
                .WithConsoleLogger()
                .With("Logging:LogLevel:Hazelcast", "Information")
                .Build();// <1>

            // log level must be a valid Microsoft.Extensions.Logging.LogLevel value
            //   Trace | Debug | Information | Warning | Error | Critical | None

            if (args.Length == 0)
            {
                // it is OK to pass the arguments in the command line
                // otherwise, they must be specified here

                // set the cluster name
                options.ClusterName = "YOUR_CLUSTER_NAME";// <2>

                // set the cloud discovery token and url
                options.Networking.Cloud.DiscoveryToken = "YOUR_CLUSTER_DISCOVERY_TOKEN";// <3>
                options.Networking.Cloud.Url = new Uri("YOUR_DISCOVERY_URL");
            }

            // make sure the client stays connected
            options.Networking.ReconnectMode = ReconnectMode.ReconnectAsync;
            
            // enable metrics
            options.Metrics.Enabled = true;

            // set ssl
            options.Networking.Ssl.Enabled = true;
            options.Networking.Ssl.ValidateCertificateChain = false;
            options.Networking.Ssl.Protocol = SslProtocols.Tls12;
            options.Networking.Ssl.CertificatePath = "client.pfx";//downloaded from cloud <4>
            options.Networking.Ssl.CertificatePassword = "YOUR_CERTIFICATE_PASSWORD";

            Console.WriteLine(" ok.");

            Console.Write("Get and connect client...");
            await using var client = await HazelcastClientFactory.StartNewClientAsync(options);// <5>
            Console.WriteLine(" ok.");

            Console.Write("Get map...");
            await using var map = await client.GetMapAsync<string, string>("map"); // <6>
            Console.WriteLine(" ok.");

            Console.Write("Put value into map...");
            await map.PutAsync("key", "value");
            Console.WriteLine(" ok.");

            Console.Write("Get value from map...");
            var value = await map.GetAsync("key");
            Console.WriteLine(" ok");

            Console.Write("Validate value...");// <7>
            if (value.Equals("value"))
            {
                Console.WriteLine("ok.");
            }
            else
            {
                Console.WriteLine("Error.");
                Console.WriteLine("Check your configuration.");
                return;
            }

            Console.WriteLine("Put/Get values in/from map with random values...");
            var random = new Random();
            var step = IterationCount / 10;
            for (var i = 0; i < IterationCount; i++)
            {
                var randomValue = random.Next(100_000);
                await map.PutAsync("key_" + randomValue, "value_" + randomValue);

                randomValue = random.Next(100_000);
                await map.GetAsync("key" + randomValue);

                if (i % step == 0)
                {
                    Console.WriteLine($"[{i:D3}] map size: {await map.GetSizeAsync()}");
                }
            }

            Console.WriteLine("Done.");
        }

        public static HazelcastOptionsBuilder WithConsoleLogger(this HazelcastOptionsBuilder builder)
        {
            return builder
                .With("Logging:LogLevel:Default", "None")
                .With("Logging:LogLevel:System", "None")
                .With("Logging:LogLevel:Microsoft", "None")
                .With((configuration, options) =>
                {
                    // configure logging factory and add the console provider
                    options.LoggerFactory.Creator = () => LoggerFactory.Create(loggingBuilder =>
                        loggingBuilder
                            .AddConfiguration(configuration.GetSection("logging"))
                            .AddConsole());
                });
        }
    }
}

----

<1> First, we create an empty client configuration.

<2> Then, we set the cluster name.
+
The cluster name is unique to your cluster. 

<3> We enable the cloud configuration by setting the discovery token.
+
The discovery token is also unique to your cluster and is used to discover Hazelcast cluster members.

<4> the lines that enable and configure SSL encryption on the client side.

<5> Now, we create the client with `config`.
+
This step creates the connection between your application and the cluster.

<6> We get/create a map and put a simple entry ("key", "value").

<7> Then, we check if the entry has been added and let the code throw an exception if the value is not correct. Finally, we add random entries.

+
You may want to move the `pfx` file to another directory. Then, you need to set `CertificateFilePath` accordingly. 

== More Configuration Options

Please refer to the link:{url-github-net}[Hazelcast .Net Client Documentation] for further configuration options.
